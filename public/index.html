<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Seek Job Explorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1220; --card:#121a2a; --muted:#93a1b1; --text:#e8eef5; --accent:#7cc4ff; --accent2:#ffd166; --danger:#ff7b7b;
      --ok:#2ecc71; --warn:#f2c94c; --chip:#1c2840;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
    a{color:var(--accent)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px 16px 80px}
    .title{font-weight:700;font-size:clamp(20px,2.6vw,32px);letter-spacing:.2px}
    .sub{color:var(--muted);margin-top:6px}
    .panel{background:var(--card);border:1px solid #1c2440;border-radius:16px;padding:16px;margin:16px 0;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .grid{display:grid;gap:12px}
    @media(min-width:720px){ .grid-3{grid-template-columns:repeat(3,1fr)} .grid-4{grid-template-columns:repeat(4,1fr)} }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    .field{flex:1;min-width:200px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,button{
      background:#0f1729;border:1px solid #223057;color:var(--text);
      border-radius:10px;padding:10px 12px;font-size:14px;width:100%;box-sizing:border-box
    }
    button{background:linear-gradient(90deg,#2563eb,#22c1c3);border:none;cursor:pointer;font-weight:600}
    button.secondary{background:#0f1729;border:1px solid #223057}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .hint{font-size:12px;color:var(--muted)}
    .warn{color:var(--danger)}
    .ok{color:var(--ok)}
    .cards{display:grid;gap:14px}
    @media(min-width:640px){ .cards{grid-template-columns:repeat(2,1fr)} }
    @media(min-width:1040px){ .cards{grid-template-columns:repeat(3,1fr)} }
    .card{background:var(--card);border:1px solid #1c2440;border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:10px}
    .card h3{margin:0;font-size:16px}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:var(--chip);color:var(--text);border:1px solid #223057;padding:4px 8px;border-radius:999px;font-size:12px}
    .meta{font-size:12px;color:var(--muted)}
    details summary{cursor:pointer;list-style:none}
    details summary::-webkit-details-marker{display:none}
    .summary{display:flex;align-items:center;gap:6px;font-weight:600}
    .linkbar{display:flex;gap:8px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:6px;background:#0f1729;border:1px solid #223057;color:var(--text);padding:8px 10px;border-radius:10px;font-size:13px;text-decoration:none}
    .sr{position:absolute;left:-9999px}
    .divider{height:1px;background:#1c2440;margin:8px 0}
    .right{margin-left:auto}
    .center{display:flex;align-items:center;justify-content:center}
    .skeleton{background:linear-gradient(90deg,#0f1729,#15203b,#0f1729);background-size:200% 100%;animation:sh 1.2s infinite}
    @keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .empty{border:1px dashed #223057;border-radius:12px;padding:24px;color:var(--muted)}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid #223057;background:#0f1729;color:var(--muted)}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
</head>
<body>
  <div class="wrap">
    <h1 class="title">Seek Job Explorer</h1>
    <p class="sub">Browse and enrich crawled SEEK jobs using your public CSV. Works on GitHub Pages (client-only).</p>

    <div class="panel" id="filterPanel">
      <h2 style="margin:0 0 12px;font-size:18px;">1) Choose filters</h2>

      <div class="grid grid-4">
        <div class="field">
          <label for="daysInput">Only show jobs crawled in the last X days</label>
          <input type="number" id="daysInput" min="0" step="1" value="7" />
          <div class="hint">0 = no time filter</div>
        </div>

        <div class="field">
          <label for="durationSpecified">duration_specified</label>
          <select id="durationSpecified">
            <option value="any" selected>Any</option>
            <option value="true">true</option>
            <option value="false">false</option>
          </select>
        </div>

        <div class="field">
          <label>duration_months (min/max)</label>
          <div class="row">
            <input type="number" id="durMin" placeholder="min" min="0" />
            <input type="number" id="durMax" placeholder="max" min="0" />
          </div>
        </div>

        <div class="field">
          <label for="renewalMentioned">renewal_mentioned</label>
          <select id="renewalMentioned">
            <option value="any" selected>Any</option>
            <option value="true">true</option>
            <option value="false">false</option>
          </select>
        </div>
      </div>

      <!-- NEW: Start filters -->
      <div class="grid grid-4" style="margin-top:12px">
        <div class="field">
          <label for="startSpecified">start_specified</label>
          <select id="startSpecified">
            <option value="any" selected>Any</option>
            <option value="true">true</option>
            <option value="false">false</option>
          </select>
        </div>

        <div class="field">
          <label>start_iso range (from/to)</label>
          <div class="row">
            <input type="date" id="startFrom" />
            <input type="date" id="startTo" />
          </div>
          <div class="hint">Jobs without a concrete date won't match this range.</div>
        </div>

        <div class="field">
          <label for="startDescriptor">start_descriptor contains…</label>
          <input type="text" id="startDescriptor" placeholder="e.g. ASAP, January, Q1" />
        </div>

        <div class="field">
          <label class="sr">spacer</label>
          <div class="hint">Tip: combine “start_specified=true” + keyword “ASAP” to find immediate starts.</div>
        </div>
      </div>

      <div class="toolbar" style="margin-top:12px">
        <button id="loadBtn">2) Load jobs</button>
        <button id="resetBtn" class="secondary">Reset</button>
        <span class="hint right" id="statusHint">Waiting for input…</span>
      </div>
      <div class="hint" id="corsHint" style="margin-top:8px;display:none">
        <span class="warn">Heads-up:</span> SEEK job detail API blocked by CORS. The page will show CSV data only. You can still open the job on SEEK.
      </div>
    </div>

    <div class="panel">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0;font-size:18px">Results</h2>
        <span class="badge" id="resultCount">0 jobs</span>
      </div>
      <div class="divider"></div>
      <div id="cards" class="cards"></div>
      <div id="empty" class="empty" style="display:none">No jobs match your filters.</div>
    </div>
  </div>

  <script>
    const CSV_URL = "https://raw.githubusercontent.com/adverbdizzy7d/Seek-Jobs/refs/heads/main/data/seek_jobs.csv";

    // controls
    const daysInput = document.getElementById('daysInput');
    const durationSpecified = document.getElementById('durationSpecified');
    const durMin = document.getElementById('durMin');
    const durMax = document.getElementById('durMax');
    const renewalMentioned = document.getElementById('renewalMentioned');

    // NEW start controls
    const startSpecified = document.getElementById('startSpecified');
    const startFrom = document.getElementById('startFrom');
    const startTo = document.getElementById('startTo');
    const startDescriptor = document.getElementById('startDescriptor');

    const loadBtn = document.getElementById('loadBtn');
    const resetBtn = document.getElementById('resetBtn');
    const cardsEl = document.getElementById('cards');
    const emptyEl = document.getElementById('empty');
    const statusHint = document.getElementById('statusHint');
    const resultCount = document.getElementById('resultCount');
    const corsHint = document.getElementById('corsHint');

    const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));
    const toBool = (v)=> String(v).toLowerCase()==='true';

    function withinDays(iso, days){
      if(!days || days<=0) return true;
      const dt = new Date(iso);
      if(isNaN(dt)) return false;
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate()-days);
      return dt >= cutoff;
    }
    function numberOrNull(v){
      if(v==='' || v===null || v===undefined) return null;
      const n = Number(v);
      return isNaN(n) ? null : n;
    }
    function fmtDate(iso){
      const d = new Date(iso);
      if(isNaN(d)) return '—';
      return d.toISOString().replace('T',' ').replace('Z',' UTC');
    }
    function withinDateRange(dateStr, fromStr, toStr){
      if(!fromStr && !toStr) return true;
      const d = new Date(dateStr);
      if(isNaN(d)) return false; // only concrete dates can match the range
      if(fromStr){
        const from = new Date(fromStr + "T00:00:00Z");
        if(d < from) return false;
      }
      if(toStr){
        const to = new Date(toStr + "T23:59:59Z");
        if(d > to) return false;
      }
      return true;
    }

    const SEEK_GQL = "/seek-gql";

    function escapeHtml(s){return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");}

    function cardSkeleton(jobId){
      const url = `https://www.seek.com.au/job/${jobId}`;
      return `<article class="card" data-id="${jobId}">
        <h3><a href="${url}" target="_blank" rel="noopener">Job ${jobId}</a></h3>
        <div class="meta">Loading SEEK details…</div>
      </article>`;
    }

    // Build exact GQL body (unchanged; kept for the SEEK details fetch)
    function buildSeekBodyExact(jobId) {
      const jobDetailsViewedCorrelationId = crypto.randomUUID();
      const sessionId = crypto.randomUUID();
      const visitorId = crypto.randomUUID();
      const query = `query jobDetails($jobId: ID!, $jobDetailsViewedCorrelationId: String!, $sessionId: String!, $zone: Zone!, $locale: Locale!, $languageCode: LanguageCodeIso!, $countryCode: CountryCodeIso2!, $timezone: Timezone!, $visitorId: UUID!, $enableApplicantCount: Boolean!, $enableWorkArrangements: Boolean!) {
        jobDetails(id: $jobId, tracking: {channel: "WEB", jobDetailsViewedCorrelationId: $jobDetailsViewedCorrelationId, sessionId: $sessionId}) {
          ...job
          insights @include(if: $enableApplicantCount) { ... on ApplicantCount { countLabel(locale: $locale) volumeLabel(locale: $locale) count __typename } __typename }
          learningInsights(platform: WEB, zone: $zone, locale: $locale) { analytics content __typename }
          gfjInfo { location { countryCode country(locale: $locale) suburb(locale: $locale) region(locale: $locale) state(locale: $locale) postcode __typename } workTypes { label __typename } company { url(locale: $locale, zone: $zone) __typename } __typename }
          workArrangements(visitorId: $visitorId, channel: "JDV", platform: WEB) @include(if: $enableWorkArrangements) { arrangements { type label(locale: $locale) __typename } label(locale: $locale) __typename }
          seoInfo { normalisedRoleTitle workType classification subClassification where(zone: $zone) broaderLocationName(locale: $locale) normalisedOrganisationName __typename }
          __typename
        }
      }
      fragment job on JobDetails {
        job {
          sourceZone
          tracking { adProductType classificationInfo { classificationId classification subClassificationId subClassification __typename } hasRoleRequirements isPrivateAdvertiser locationInfo { area location locationIds __typename } workTypeIds postedTime __typename }
          id title phoneNumber isExpired
          expiresAt { dateTimeUtc __typename }
          isLinkOut contactMatches { type value __typename } isVerified abstract content(platform: WEB) status
          listedAt { label(context: JOB_POSTED, length: SHORT, timezone: $timezone, locale: $locale) dateTimeUtc __typename }
          salary { currencyLabel(zone: $zone) label __typename }
          shareLink(platform: WEB, zone: $zone, locale: $locale)
          workTypes { label(locale: $locale) __typename }
          advertiser { id name(locale: $locale) isVerified registrationDate { dateTimeUtc __typename } __typename }
          location { label(locale: $locale, type: LONG) __typename }
          classifications { label(languageCode: $languageCode) __typename }
          products { branding { id cover { url __typename } thumbnailCover: cover(isThumbnail: true) { url __typename } logo { url __typename } __typename } bullets questionnaire { questions __typename } video { url position __typename } displayTags { label(locale: $locale) __typename } __typename }
          __typename
        }
        companyProfile(zone: $zone) { id name companyNameSlug shouldDisplayReviews branding { logo __typename } overview { description { paragraphs __typename } industry size { description __typename } website { url __typename } __typename } reviewsSummary { overallRating { numberOfReviews { value __typename } value __typename } __typename } perksAndBenefits { title __typename } __typename }
        companySearchUrl(zone: $zone, languageCode: $languageCode)
        companyTags { key(languageCode: $languageCode) value __typename }
        restrictedApplication(countryCode: $countryCode) { label(locale: $locale) __typename }
        sourcr { image imageMobile link __typename }
        __typename
      }`;
      const body = {
        operationName: "jobDetails",
        variables: {
          jobId,
          jobDetailsViewedCorrelationId,
          sessionId,
          zone: "anz-1",
          locale: "en-AU",
          languageCode: "en",
          countryCode: "AU",
          timezone: "Europe/Berlin",
          visitorId,
          enableApplicantCount: false,
          enableWorkArrangements: true
        },
        query
      };
      return JSON.stringify(body);
    }

    async function fetchSeekDetails(jobId) {
      const res = await fetch(SEEK_GQL, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Accept": "*/*" },
        body: buildSeekBodyExact(jobId)
      });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const json = await res.json();
      return json?.data?.jobDetails?.job;
    }

    function fmtStartChip(row){
      const specified = String(row.start_specified ?? '').toLowerCase();
      const isSpecified = specified === 'true';
      const iso = row.start_iso || '';
      const desc = row.start_descriptor || (isSpecified ? '' : 'not specified');
      const parts = [];
      parts.push(`<span class='chip'>start_specified: ${isSpecified}</span>`);
      parts.push(`<span class='chip'>start_iso: ${iso || '—'}</span>`);
      parts.push(`<span class='chip'>start_descriptor: ${escapeHtml(desc || '—')}</span>`);
      return parts.join('');
    }

    function fmt(job,row,cors){
      const url=`https://www.seek.com.au/job/${row.jobID}`;
      const title=job?.title||`Job ${row.jobID}`;
      const loc=job?.location?.label||"—";
      const exp=job?.isExpired?"Expired":"Active";
      const exAt=job?.expiresAt?.dateTimeUtc?fmtDate(job.expiresAt.dateTimeUtc):"—";
      const bullets=(job?.products?.bullets||[]).map(b=>`<li>${escapeHtml(b)}</li>`).join("");
      const abs=job?.abstract?escapeHtml(job.abstract):"—";
      const html=job?.content||"<em>No content</em>";
      const corsNote=cors?`<div class='hint warn'>CORS blocked, CSV only.</div>`:"";
      return `<article class='card'>
        <h3><a href='${url}' target='_blank' rel='noopener'>${title}</a></h3>
        <div class='chips'>
          <span class='chip'>${exp}</span>
          <span class='chip'>Location: ${loc}</span>
          <span class='chip'>Expires: ${exAt}</span>
        </div>
        <div class='meta'>Crawl: ${fmtDate(row.CrawlTime)}</div>
        <div class='chips'>
          <span class='chip'>duration_specified: ${row.duration_specified}</span>
          <span class='chip'>duration_months: ${row.duration_months}</span>
          <span class='chip'>renewal_mentioned: ${row.renewal_mentioned}</span>
        </div>
        <div class='chips'>
          ${fmtStartChip(row)}
        </div>
        ${corsNote}
        <p><strong>Abstract:</strong> ${abs}</p>
        ${bullets?`<ul>${bullets}</ul>`:""}
        <details><summary class='summary'>Show description</summary><div>${html}</div></details>
        <div class='linkbar'>
          <a class='btn' href='${url}' target='_blank' rel='noopener'>Open on SEEK</a>
        </div>
      </article>`;
    }

    function setStatus(m){statusHint.textContent=m;}

    loadBtn.addEventListener('click',async()=>{
      setStatus("Loading CSV…");
      corsHint.style.display="none";
      cardsEl.innerHTML="";
      emptyEl.style.display="none";
      resultCount.textContent="0 jobs";

      let csvText;
      try{
        const res=await fetch(CSV_URL,{cache:"no-store"});
        if(!res.ok)throw new Error(res.status);
        csvText=await res.text();
      }catch(e){
        setStatus("Failed: "+e.message);
        return;
      }

      const parsed=Papa.parse(csvText,{header:true,skipEmptyLines:true});

      // Map CSV rows with safe defaults (backward compatible)
      let rows=parsed.data.map(r=>({
        CrawlTime: r.CrawlTime,
        jobID: r.jobID,
        duration_specified: String(r.duration_specified).toLowerCase(),
        duration_months: Number(r.duration_months),
        renewal_mentioned: String(r.renewal_mentioned).toLowerCase(),
        start_specified: (r.start_specified!==undefined && r.start_specified!==null && r.start_specified!=='') ? String(r.start_specified).toLowerCase() : 'false',
        start_iso: r.start_iso || '',
        start_descriptor: r.start_descriptor || (String(r.start_specified).toLowerCase()==='true' ? '' : 'not specified')
      }));

      // Read filters
      const days=Number(daysInput.value);
      const ds=durationSpecified.value;
      const rm=renewalMentioned.value;
      const mn=numberOrNull(durMin.value);
      const mx=numberOrNull(durMax.value);

      const ss=startSpecified.value;
      const sf=startFrom.value;
      const st=startTo.value;
      const sd=(startDescriptor.value || '').trim().toLowerCase();

      // Apply filters
      rows=rows.filter(r=>{
        if(!withinDays(r.CrawlTime,days)) return false;

        if(ds!=='any' && r.duration_specified!==ds) return false;
        if(rm!=='any' && r.renewal_mentioned!==rm) return false;
        if(mn!==null && r.duration_months<mn) return false;
        if(mx!==null && r.duration_months>mx) return false;

        if(ss!=='any' && r.start_specified!==ss) return false;

        // Date range filter (only matches when start_iso is a valid date)
        if((sf || st) && !withinDateRange(r.start_iso, sf, st)) return false;

        // Descriptor keyword filter (case-insensitive substring)
        if(sd && String(r.start_descriptor||'').toLowerCase().indexOf(sd)===-1) return false;

        return true;
      });

      if(!rows.length){
        emptyEl.style.display="block";
        setStatus("No matches");
        resultCount.textContent="0 jobs";
        return;
      }

      // Render skeletons
      cardsEl.innerHTML=rows.map(r=>cardSkeleton(r.jobID)).join("");
      resultCount.textContent=`${rows.length} jobs`;
      setStatus("Fetching SEEK details…");

      // Fetch SEEK details in parallel with throttling; handle CORS gracefully
      let cors=false; const resArr=[]; let i=0;
      async function worker(){
        while(i<rows.length){
          const idx=i++;
          try{
            const j=await fetchSeekDetails(rows[idx].jobID);
            resArr[idx]={job:j,ok:true};
            await sleep(150);
          }catch(e){
            resArr[idx]={job:null,ok:false};
            cors=true;
          }
        }
      }
      await Promise.all(Array.from({length:3},worker));
      if(cors) corsHint.style.display="block";

      // Final render
      cardsEl.innerHTML=rows.map((r,i)=>fmt(resArr[i]?.job,r,cors && !resArr[i]?.ok)).join("");
      setStatus("Done.");
    });

    resetBtn.addEventListener('click',()=>{
      daysInput.value=7;
      durationSpecified.value='any';
      durMin.value='';
      durMax.value='';
      renewalMentioned.value='any';

      startSpecified.value='any';
      startFrom.value='';
      startTo.value='';
      startDescriptor.value='';

      cardsEl.innerHTML='';
      emptyEl.style.display="none";
      resultCount.textContent='0 jobs';
      statusHint.textContent='Waiting for input…';
      corsHint.style.display='none';
    });
  </script>
</body>
</html>
